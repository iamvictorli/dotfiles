#!/usr/bin/env bash
#
# benchmark-zsh - Benchmark Zsh shell startup performance using hyperfine
#

set -euo pipefail

# Colors (matching dot script)
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[0;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly RESET='\033[0m'
readonly BOLD='\033[1m'

# Defaults
RUNS=10
WARMUP=3
SHELL_TYPE="interactive"
SHOW_OUTPUT=false
COMPARE_FISH=false
ZSHRC_PATH="${ZDOTDIR:-$HOME}/.zshrc"
JSON_FILE=""

# Helper functions (matching dot script style)
print_header() {
    echo -e "\n${BOLD}${BLUE}==>${RESET} ${BOLD}$1${RESET}"
}

print_success() {
    echo -e "${GREEN}✓${RESET} $1"
}

print_error() {
    echo -e "${RED}✗${RESET} $1" >&2
}

print_warning() {
    echo -e "${YELLOW}⚠${RESET} $1"
}

print_info() {
    echo -e "${CYAN}ℹ${RESET} $1"
}

command_exists() {
    command -v "$1" >/dev/null 2>&1
}

usage() {
    cat << EOF
${BOLD}USAGE:${RESET}
    benchmark-zsh [OPTIONS]

${BOLD}DESCRIPTION:${RESET}
    Benchmark Zsh shell startup performance using hyperfine.
    By default, measures interactive shell startup (loads ~/.zshrc).

${BOLD}OPTIONS:${RESET}
    -r, --runs NUM      Number of benchmark runs (default: 10)
    -w, --warmup NUM    Number of warmup runs (default: 3)
    -l, --login         Benchmark login shell (full profile chain)
    -c, --compare       Compare with Fish shell startup
    -f, --full          Show hyperfine's full output
    -h, --help          Show this help

${BOLD}SHELL TYPES:${RESET}
    Interactive (default):  zsh -i -c exit    (loads ~/.zshrc)
    Login (-l):             zsh -l -c exit    (loads full profile chain)

${BOLD}EXAMPLES:${RESET}
    benchmark-zsh                 # 10 runs, 3 warmup
    benchmark-zsh -r 20           # 20 runs
    benchmark-zsh -c              # Compare with Fish
    benchmark-zsh -l              # Benchmark login shell
    benchmark-zsh -r 15 -w 5 -f   # 15 runs, 5 warmup, full output

${BOLD}PROFILING:${RESET}
    To find slow parts of your .zshrc, add:
      # At TOP of ~/.zshrc:
      zmodload zsh/zprof
      # At BOTTOM of ~/.zshrc:
      zprof

EOF
}

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -r|--runs)
                RUNS="$2"
                shift 2
                ;;
            -w|--warmup)
                WARMUP="$2"
                shift 2
                ;;
            -l|--login)
                SHELL_TYPE="login"
                shift
                ;;
            -c|--compare)
                COMPARE_FISH=true
                shift
                ;;
            -f|--full)
                SHOW_OUTPUT=true
                shift
                ;;
            -h|--help)
                usage
                exit 0
                ;;
            *)
                print_error "Unknown option: $1"
                echo "Run 'benchmark-zsh --help' for usage"
                exit 1
                ;;
        esac
    done
}

check_dependencies() {
    if ! command_exists zsh; then
        print_error "Zsh shell is not installed"
        exit 1
    fi

    if ! command_exists hyperfine; then
        print_error "hyperfine is not installed"
        print_info "Install it first: brew install hyperfine"
        exit 1
    fi

    if [[ "$COMPARE_FISH" == true ]] && ! command_exists fish; then
        print_warning "Fish is not installed, skipping comparison"
        COMPARE_FISH=false
    fi
}

validate_options() {
    if ! [[ "$RUNS" =~ ^[0-9]+$ ]] || [[ "$RUNS" -lt 1 ]] || [[ "$RUNS" -gt 100 ]]; then
        print_error "Number of runs must be between 1 and 100"
        exit 1
    fi

    if ! [[ "$WARMUP" =~ ^[0-9]+$ ]] || [[ "$WARMUP" -gt 20 ]]; then
        print_error "Warmup runs must be between 0 and 20"
        exit 1
    fi
}

run_benchmark() {
    local zsh_flags="-i"
    local shell_desc="interactive"
    
    if [[ "$SHELL_TYPE" == "login" ]]; then
        zsh_flags="-l"
        shell_desc="login"
    fi

    print_header "Benchmarking Zsh shell startup performance"
    
    print_info "Running $RUNS Zsh shell startup benchmarks..."
    
    # Create temp file for JSON export
    JSON_FILE=$(mktemp)

    # Build hyperfine command
    local -a cmd=(hyperfine --warmup "$WARMUP" --runs "$RUNS" --shell=none --export-json "$JSON_FILE")
    
    if [[ "$SHOW_OUTPUT" == false ]]; then
        cmd+=(--style basic)
    fi

    if [[ "$COMPARE_FISH" == true ]]; then
        "${cmd[@]}" \
            --command-name "zsh (${shell_desc})" "zsh ${zsh_flags} -c exit" \
            --command-name "fish" "fish -c exit"
    else
        "${cmd[@]}" \
            --command-name "zsh (${shell_desc})" "zsh ${zsh_flags} -c exit"
    fi
    
    # Generate report
    print_header "Zsh Shell Startup Benchmark Results"
    echo ""
    echo -e "${BOLD}Configuration:${RESET}"
    echo "  Shell: $(zsh --version)"
    echo "  Type: ${shell_desc} (zsh ${zsh_flags} -c exit)"
    echo "  Runs: $RUNS"
    echo "  Warmup: $WARMUP"
    echo ""
    
    # Parse JSON for statistics
    if [[ -f "$JSON_FILE" ]]; then
        local mean_sec min_sec max_sec stddev_sec
        mean_sec=$(grep -o '"mean": *[0-9.]*' "$JSON_FILE" | head -1 | sed 's/.*: *//')
        min_sec=$(grep -o '"min": *[0-9.]*' "$JSON_FILE" | head -1 | sed 's/.*: *//')
        max_sec=$(grep -o '"max": *[0-9.]*' "$JSON_FILE" | head -1 | sed 's/.*: *//')
        stddev_sec=$(grep -o '"stddev": *[0-9.]*' "$JSON_FILE" | head -1 | sed 's/.*: *//')
        
        if [[ -n "$mean_sec" ]]; then
            echo -e "${BOLD}Performance Results:${RESET}"
            printf "  Average time: ${GREEN}%.3f${RESET} seconds\n" "$mean_sec"
            [[ -n "$min_sec" ]] && printf "  Fastest time: ${GREEN}%.3f${RESET} seconds\n" "$min_sec"
            [[ -n "$max_sec" ]] && printf "  Slowest time: ${YELLOW}%.3f${RESET} seconds\n" "$max_sec"
            
            if [[ -n "$min_sec" && -n "$max_sec" ]]; then
                local range
                range=$(awk "BEGIN {printf \"%.3f\", $max_sec - $min_sec}")
                printf "  Time range:   ${CYAN}%.3f${RESET} seconds\n" "$range"
            fi
        fi
    fi
}

assess_performance() {
    [[ ! -f "$JSON_FILE" ]] && return 0

    # Extract mean time in seconds from JSON
    local mean_sec
    mean_sec=$(grep -o '"mean": *[0-9.]*' "$JSON_FILE" | head -1 | sed 's/.*: *//')
    
    # Cleanup
    rm -f "$JSON_FILE"
    
    [[ -z "$mean_sec" ]] && return 0

    # Convert to milliseconds for display
    local mean_ms
    mean_ms=$(awk "BEGIN {printf \"%.0f\", $mean_sec * 1000}")

    echo ""
    echo -e "${BOLD}Performance Assessment:${RESET}"
    
    # Performance thresholds (in seconds)
    local excellent=0.050
    local good=0.100
    local fair=0.200

    if (( $(echo "$mean_sec <= $excellent" | bc -l) )); then
        print_success "Excellent startup performance! (${mean_ms}ms, target: ≤50ms)"
    elif (( $(echo "$mean_sec <= $good" | bc -l) )); then
        print_success "Good startup performance (${mean_ms}ms, target: ≤100ms)"
    elif (( $(echo "$mean_sec <= $fair" | bc -l) )); then
        print_warning "Fair startup performance (${mean_ms}ms, target: ≤200ms)"
    else
        print_warning "Slow startup performance (${mean_ms}ms, target: ≤200ms)"
        echo ""
        print_info "Tips to improve Zsh shell startup time:"
        print_info "  - Profile with zprof (add 'zmodload zsh/zprof' at top, 'zprof' at bottom)"
        print_info "  - Cache slow tool inits (like _cache_init pattern)"
        print_info "  - Lazy-load completions and plugins"
        print_info "  - Check for slow network operations in startup scripts"
    fi
}

check_uncached_evals() {
    [[ ! -f "$ZSHRC_PATH" ]] && return 0

    local uncached
    uncached=$(grep -n 'eval "\$(' "$ZSHRC_PATH" 2>/dev/null | grep -v '_cache_init\|#' || true)

    if [[ -n "$uncached" ]]; then
        echo ""
        print_warning "Potential slow commands in ~/.zshrc (not cached):"
        echo "$uncached" | while IFS= read -r line; do
            echo "  ${line}"
        done
        print_info "Consider using _cache_init for these commands"
    fi
    
    echo ""
    print_info "Zsh config location: ~/.zshrc"
}

main() {
    parse_args "$@"
    check_dependencies
    validate_options
    run_benchmark
    assess_performance
    check_uncached_evals
}

main "$@"
